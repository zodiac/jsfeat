<!doctype html>

<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="A JavaScript Computer Vision Library">
        <meta name="author" content="Eugene Zatepyakin">
        <title>JSFeat - JavaScript Computer Vision Library.</title>

        <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Droid+Sans:regular,bold|Inconsolata|PT+Sans:400,700">
        <link rel="stylesheet" href="css/bootstrap.css">
        <link rel="stylesheet" href="css/jsfeat.css">
    </head>
    <body style="background: black">
            <video id="webcam" width="640" height="480" style="display:none;"></video>
            <div style=" width:640px;height:480px;margin: 10px auto;transform:scaleX(-1)">
                <canvas id="canvas" width="640" height="480"></canvas>
                <div id="no_rtc" class="alert alert-error" style="display:none;"></div>
            </div>

        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script type="text/javascript" src="js/jsfeat-min.js"></script>
        <script type="text/javascript" src="js/frontalface.js"></script>
        <script type="text/javascript" src="js/compatibility.js"></script>
        <script type="text/javascript" src="js/profiler.js"></script>
        <script type="text/javascript" src="js/dat.gui.min.js"></script>
        <script type="text/javascript">

        window.hairOffset = {
            'HAIR1.png': 0.4,
            'HAIR2.png': 0.5,
            'HAIR3.png': 0.25,
        };

        window.mode = null;

        $(window).load(function() {
            "use strict";

            // lets do some fun
            var video = document.getElementById('webcam');
            var canvas = document.getElementById('canvas');
            try {
                var attempts = 0;
                var readyListener = function(event) {
                    findVideoSize();
                };
                var findVideoSize = function() {
                    if(video.videoWidth > 0 && video.videoHeight > 0) {
                        video.removeEventListener('loadeddata', readyListener);
                        onDimensionsReady(video.videoWidth, video.videoHeight);
                    } else {
                        if(attempts < 10) {
                            attempts++;
                            setTimeout(findVideoSize, 200);
                        } else {
                            onDimensionsReady(640, 480);
                        }
                    }
                };
                var onDimensionsReady = function(width, height) {
                    demo_app(width, height);
                    compatibility.requestAnimationFrame(tick);
                };

                video.addEventListener('loadeddata', readyListener);

                compatibility.getUserMedia({video: true}, function(stream) {
                    try {
                        video.src = compatibility.URL.createObjectURL(stream);
                    } catch (error) {
                        video.src = stream;
                    }
                    setTimeout(function() {
                            video.play();
                        }, 500);
                }, function (error) {
                    console.log(error);
                    $('#canvas').hide();
                    $('#no_rtc').html('<h4>WebRTC not available.</h4>');
                    $('#no_rtc').show();
                });
            } catch (error) {
                $('#canvas').hide();
                $('#no_rtc').html('<h4>Something goes wrong...</h4>');
                $('#no_rtc').show();
            }

            var options,ctx,canvasWidth,canvasHeight;
            var img_u8,work_canvas,work_ctx,ii_sum,ii_sqsum,ii_tilted,edg,ii_canny;
            var classifier = jsfeat.haar.frontalface;

            var max_work_size = 160;

            var demo_opt = function(){
                this.min_scale = 2;
                this.scale_factor = 1.15;
                this.use_canny = false;
                this.edges_density = 0.13;
                this.equalize_histogram = true;
            }

            function demo_app(videoWidth, videoHeight) {
                canvasWidth  = canvas.width;
                canvasHeight = canvas.height;
                ctx = canvas.getContext('2d');

                ctx.fillStyle = "rgb(0,255,0)";
                ctx.strokeStyle = "rgb(0,255,0)";

                var scale = Math.min(max_work_size/videoWidth, max_work_size/videoHeight);
                var w = (videoWidth*scale)|0;
                var h = (videoHeight*scale)|0;

                img_u8 = new jsfeat.matrix_t(w, h, jsfeat.U8_t | jsfeat.C1_t);
                edg = new jsfeat.matrix_t(w, h, jsfeat.U8_t | jsfeat.C1_t);
                work_canvas = document.createElement('canvas');
                work_canvas.width = w;
                work_canvas.height = h;
                work_ctx = work_canvas.getContext('2d');
                ii_sum = new Int32Array((w+1)*(h+1));
                ii_sqsum = new Int32Array((w+1)*(h+1));
                ii_tilted = new Int32Array((w+1)*(h+1));
                ii_canny = new Int32Array((w+1)*(h+1));

                options = new demo_opt();
            }

            function tick() {
                compatibility.requestAnimationFrame(tick);
                if (video.readyState === video.HAVE_ENOUGH_DATA) {

                    ctx.clearRect(0, 0, canvasWidth, canvasHeight);
                    
                    if (window.mode !== 'tracking') {
                        ctx.drawImage(video, 0, 0, canvasWidth, canvasHeight);
                    }

                    work_ctx.drawImage(video, 0, 0, work_canvas.width, work_canvas.height);
                    var imageData = work_ctx.getImageData(0, 0, work_canvas.width, work_canvas.height);
                    
                    jsfeat.imgproc.grayscale(imageData.data, work_canvas.width, work_canvas.height, img_u8);

                    if(options.equalize_histogram) {
                        jsfeat.imgproc.equalize_histogram(img_u8, img_u8);
                    }

                    jsfeat.imgproc.compute_integral_image(img_u8, ii_sum, ii_sqsum, classifier.tilted ? ii_tilted : null);

                    if(options.use_canny) {
                        jsfeat.imgproc.canny(img_u8, edg, 10, 50);
                        jsfeat.imgproc.compute_integral_image(edg, ii_canny, null, null);
                    }

                    jsfeat.haar.edges_density = options.edges_density;
                    var rects = jsfeat.haar.detect_multi_scale(ii_sum, ii_sqsum, ii_tilted, options.use_canny? ii_canny : null, img_u8.cols, img_u8.rows, classifier, options.scale_factor, options.min_scale);
                    rects = jsfeat.haar.group_rectangles(rects, 1);

                    // draw only most confident one
                    draw_faces(ctx, rects, canvasWidth/img_u8.cols, 1);
                }
            }

            function draw_faces(ctx, rects, sc, max) {
                var on = rects.length;
                if(on && max) {
                    jsfeat.math.qsort(rects, 0, on-1, function(a,b){return (b.confidence<a.confidence);})
                }
                var n = max || on;
                n = Math.min(n, on);
                var r;
                for(var i = 0; i < n; ++i) {
                    r = rects[i];

                    if (window.mode !== 'tracking') {
                        ctx.strokeRect((r.x*sc)|0,(r.y*sc)|0,(r.width*sc)|0,(r.height*sc)|0);
                    }

                    if (window.mode === 'tracking') {
                        var viewportWidth = window.calibration.right - window.calibration.left;
                        var viewportHeight = window.calibration.bottom - window.calibration.top;

                        var canvasLeft = canvasWidth - (r.x + r.width)*sc;
                        var viewportLeft = canvasLeft - window.calibration.left;
                        var windowLeft = (document.documentElement.clientWidth) * (viewportLeft / viewportWidth);

                        var canvasTop = r.y*sc;
                        var viewportTop = canvasTop - window.calibration.top;
                        var windowTop = (document.documentElement.clientHeight) * (viewportTop / viewportHeight);

                        var canvasRight = canvasWidth - r.x*sc;
                        var canvasBottom = (r.y + r.height)*sc;

                        var tbCanvasWidth = canvasRight - canvasLeft;
                        var tbCanvasHeight = canvasBottom - canvasTop;

                        var tbWindowWidth = document.documentElement.clientWidth * tbCanvasWidth / canvasWidth;
                        var tbWindowHeight = document.documentElement.clientHeight * tbCanvasHeight / canvasHeight;

                        $("#trackingBox").css({
                            'left': windowLeft,
                            'top': windowTop,
                            'width': tbWindowWidth,
                            'height': tbWindowHeight,
                        });

                        $("#hatBox").css({
                            'top': windowTop - $("#hatBox").height() * hairOffset[$("#hatBox").attr("src")],
                            'left': windowLeft + tbWindowWidth / 2 - $("#hatBox").width() / 2,
                            'width': tbWindowWidth,
                        });

                        $("#moustacheBox").css({
                            'top': windowTop + tbWindowHeight / 2,
                            'left': windowLeft + tbWindowWidth / 2 - $("#moustacheBox").width() / 2,
                        });
                    }

                    if (window.mode === 'calibration') {
                        window.calibration.left = Math.min(window.calibration.left, canvasWidth - (r.x + r.width)*sc);
                        window.calibration.top = Math.min(window.calibration.top, r.y*sc);
                        window.calibration.right = Math.max(window.calibration.right, canvasWidth - r.x*sc);
                        window.calibration.bottom = Math.max(window.calibration.bottom, (r.y + r.height)*sc);
                    }
                }
            }

            $(window).unload(function() {
                video.pause();
                video.src=null;
            });
        });

        </script>

        <div id="trackingBox" style="position: absolute; width: 10px; height: 300px; border: 1px solid pink"></div>
        <img id="hatBox" src="HAIR3.png" width="350" style="position:absolute" />
        <img id="moustacheBox" src="http://pngimg.com/upload/beard_PNG6268.png" width="350" style="position:absolute;-webkit-filter:invert(100%)" />

        <script>

        $("#hatBox").hide();
        $("#moustacheBox").hide();

        $(document).keyup(function (e) {
            if (e.which === 67) { /*c*/
                window.calibration = {
                    left: 10000,
                    right: 0,
                    top: 1000,
                    bottom: 0,
                };
                window.mode = 'calibration';
            } else if (e.which === 69) { /*e*/
                window.mode = 'tracking';
                $('#hatBox').show();
                console.log(window.calibration);
            } else if (e.which === 66) { /*b*/
                $("#trackingBox").toggle();
            } else if (e.which === 83) { /*s*/
                if ($("#hatBox").attr("src") === 'HAIR3.png') {
                    $("#hatBox").attr("src", 'HAIR1.png');
                } else if ($("#hatBox").attr("src") === 'HAIR1.png') {
                    $("#hatBox").attr("src", 'HAIR2.png');
                } else if ($("#hatBox").attr("src") === 'HAIR2.png') {
                    $("#hatBox").attr("src", 'HAIR3.png');
                }
            } else if (e.which === 77) { /*m*/
                $("#moustacheBox").toggle();
            }
        });

        </script>

    </body>
</html>